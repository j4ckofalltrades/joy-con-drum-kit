function e(e,t){let a=(t=t||{}).beta||.4,i=!0!==t.doInitialisation,n=1,s=0,r=0,c=0,l=1/(1e3/e);function o(e,t,a,i,n,s){return{x:t*s-a*n,y:a*i-e*s,z:e*n-t*i}}function d(e,t,a,l,d,u){let h=function(e){let t=Math.cos(.5*e.heading),a=Math.sin(.5*e.heading),i=Math.cos(.5*e.pitch),n=Math.sin(.5*e.pitch),s=Math.cos(.5*e.roll),r=Math.sin(.5*e.roll);return{w:s*i*t+r*n*a,x:r*i*t-s*n*a,y:s*n*t+r*i*a,z:s*i*a-r*n*t}}(function(e,t,a,i,n,s){let r=-Math.atan2(e,Math.sqrt(t*t+a*a)),c=o(e,t,a,1,0,0),l=o(1,0,0,c.x,c.y,c.z),d=Math.atan2(l.y,l.z),u=Math.cos(d),h=Math.sin(r),p=Math.sin(d),w=i*Math.cos(r)+n*p*h+s*u*h;return{heading:-Math.atan2(n*u-s*p,w),pitch:r,roll:d}}(e,t,a,l,d,u)),p=(h.w*h.w+h.x*h.x+h.y*h.y+h.z*h.z)**-.5;n=h.w*p,s=h.x*p,r=h.y*p,c=h.z*p,i=!0}return{update:function(e,t,o,u,h,p,w,y,m,v){let x,b,_,f,g,M,I,S,E,z,R,L,F,k,D,U,A,C,P,V,q,B,$,j,O,H,J,N,Q,T,G,K,W,X,Y;if(l=v||l,i||d(u,h,p,w,y,m),void 0===w||void 0===y||void 0===m||0===w&&0===y&&0===m){var Z,ee,et;let i,d,w,y,m,v,x,b,_,f,g,M,I,S,E,z,R,L,F,k,D,U;return void(Z=u,ee=h,et=p,v=.5*(-s*e-r*t-c*o),x=.5*(n*e+r*o-c*t),b=.5*(n*t-s*o+c*e),_=.5*(n*o+s*t-r*e),(0!==Z||0!==ee||0!==et)&&(i=(Z*Z+ee*ee+et*et)**-.5,Z*=i,ee*=i,et*=i,f=2*n,g=2*s,M=2*r,I=2*c,S=4*n,E=4*s,z=4*r,R=8*s,L=8*r,F=n*n,k=s*s,D=r*r,U=c*c,i=((d=S*D+M*Z+S*k-g*ee)*d+(w=E*U-I*Z+4*F*s-f*ee-E+R*k+R*D+E*et)*w+(y=4*F*r+f*Z+z*U-I*ee-z+L*k+L*D+z*et)*y+(m=4*k*c-g*Z+4*D*c-M*ee)*m)**-.5,d*=i,w*=i,y*=i,m*=i,v-=a*d,x-=a*w,b-=a*y,_-=a*m),n+=v*l,s+=x*l,r+=b*l,c+=_*l,i=(n*n+s*s+r*r+c*c)**-.5,n*=i,s*=i,r*=i,c*=i)}M=.5*(-s*e-r*t-c*o),I=.5*(n*e+r*o-c*t),S=.5*(n*t-s*o+c*e),E=.5*(n*o+s*t-r*e),(0!==u||0!==h||0!==p)&&(x=(u*u+h*h+p*p)**-.5,u*=x,h*=x,p*=x,x=(w*w+y*y+m*m)**-.5,w*=x,y*=x,m*=x,L=2*n*w,F=2*n*y,k=2*n*m,D=2*s*w,V=2*n,q=2*s,B=2*r,$=2*c,j=2*n*r,O=2*r*c,H=n*n,J=n*s,N=n*r,Q=n*c,T=s*s,G=s*r,K=s*c,W=r*r,X=r*c,Y=c*c,U=Math.sqrt((z=w*H-F*c+k*r+w*T+q*y*r+q*m*c-w*W-w*Y)*z+(R=L*c+y*H-k*s+D*r-y*T+y*W+B*m*c-y*Y)*R),A=-L*r+F*s+m*H+D*c-m*T+B*y*c-m*W+m*Y,C=2*U,P=2*A,x=((b=-B*(2*K-j-u)+q*(2*J+O-h)-A*r*(U*(.5-W-Y)+A*(K-N)-w)+(-U*c+A*s)*(U*(G-Q)+A*(J+X)-y)+U*r*(U*(N+K)+A*(.5-T-W)-m))*b+(_=$*(2*K-j-u)+V*(2*J+O-h)-4*s*(1-2*T-2*W-p)+A*c*(U*(.5-W-Y)+A*(K-N)-w)+(U*r+A*n)*(U*(G-Q)+A*(J+X)-y)+(U*c-P*s)*(U*(N+K)+A*(.5-T-W)-m))*_+(f=-V*(2*K-j-u)+$*(2*J+O-h)-4*r*(1-2*T-2*W-p)+(-C*r-A*n)*(U*(.5-W-Y)+A*(K-N)-w)+(U*s+A*c)*(U*(G-Q)+A*(J+X)-y)+(U*n-P*r)*(U*(N+K)+A*(.5-T-W)-m))*f+(g=q*(2*K-j-u)+B*(2*J+O-h)+(-C*c+A*s)*(U*(.5-W-Y)+A*(K-N)-w)+(-U*n+A*r)*(U*(G-Q)+A*(J+X)-y)+U*s*(U*(N+K)+A*(.5-T-W)-m))*g)**-.5,b*=x,_*=x,f*=x,g*=x,M-=a*b,I-=a*_,S-=a*f,E-=a*g),n+=M*l,s+=I*l,r+=S*l,c+=E*l,x=(n*n+s*s+r*r+c*c)**-.5,n*=x,s*=x,r*=x,c*=x},init:d,getQuaternion:()=>({w:n,x:s,y:r,z:c})}}const t=new e(10),a=new e(10),i=180/Math.PI;function n(e){var t=e,a=e=>e;let i=null==t?0:t.length;return i?function(e,t){let a;for(let i of e){let e=t(i);void 0!==e&&(a=void 0===a?e:a+e)}return a}(t,a)/i:NaN}const s={1:"Left Joy-Con",2:"Right Joy-Con",3:"Pro Controller"},r=Math.PI/2;function c(e){return parseFloat((244e-6*new DataView(e.buffer).getInt16(0,!0)).toFixed(6))}function l(e){return parseFloat((.06103*new DataView(e.buffer).getInt16(0,!0)).toFixed(6))}function o(e){return parseFloat((1694e-7*new DataView(e.buffer).getInt16(0,!0)).toFixed(6))}function d(e){let t=.005*e.length,a=[n(e.map(e=>e[0])),n(e.map(e=>e[1])),n(e.map(e=>e[2]))].map(e=>parseFloat((e*t).toFixed(6)));return{x:a[0],y:a[1],z:a[2]}}const u=async e=>{let t=({subcommand:e,expectedReport:t,timeoutErrorMessage:a="timeout."})=>i=>new Promise(async(n,s)=>{let r=setTimeout(()=>{i.removeEventListener("inputreport",c),s(Error(a))},5e3),c=e=>{if(33!==e.reportId)return;let a=new Uint8Array(e.data.buffer);for(let[e,i]of Object.entries(t))if(a[e-1]!==i)return;i.removeEventListener("inputreport",c),clearTimeout(r),setTimeout(n,50)};i.addEventListener("inputreport",c),await i.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,...e]))});t({subcommand:[3,48],expectedReport:{14:3}});let a=t({subcommand:[34,1],expectedReport:{13:128,14:34}}),i=t({subcommand:[33,33,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,243],expectedReport:{14:33}}),n=t({subcommand:[89],expectedReport:{14:89,16:32},timeoutErrorMessage:"ring-con not found."}),s=t({subcommand:[92,6,3,37,6,0,0,0,0,28,22,237,52,54,0,0,0,10,100,11,230,169,34,0,0,4,0,0,0,0,0,0,0,144,168,225,52,54],expectedReport:{14:92}}),r=t({subcommand:[90,4,1,1,2],expectedReport:{14:90}});await a(e),await i(e),await n(e),await s(e),await r(e)};class h extends EventTarget{constructor(e){super(),this.device=e,this.lastValues={timestamp:null,alpha:0,beta:0,gamma:0}}async open(){this.device.opened||await this.device.open(),this.device.addEventListener("inputreport",this._onInputReport.bind(this))}async getRequestDeviceInfo(){let e=new Promise(e=>{let t=({detail:a})=>{this.removeEventListener("deviceinfo",t),delete a._raw,delete a._hex,e(a)};this.addEventListener("deviceinfo",t)});return await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,2])),e}async getBatteryLevel(){let e=new Promise(e=>{let t=({detail:a})=>{this.removeEventListener("batterylevel",t),delete a._raw,delete a._hex,e(a)};this.addEventListener("batterylevel",t)});return await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,80])),e}async enableSimpleHIDMode(){await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,3,63]))}async enableStandardFullMode(){await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,3,48]))}async enableIMUMode(){await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,64,1]))}async disableIMUMode(){await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,64,0]))}async enableVibration(){await this.device.sendReport(1,new Uint8Array([0,0,1,64,64,0,1,64,64,72,1]))}async disableVibration(){await this.device.sendReport(1,new Uint8Array([0,0,1,64,64,0,1,64,64,72,0]))}async enableRingCon(){await u(this.device)}async enableUSBHIDJoystickReport(){null!=this.device.collections[0].outputReports.find(e=>128==e.reportId)&&(await this.device.sendReport(128,new Uint8Array([1])),await this.device.sendReport(128,new Uint8Array([2])),await this.device.sendReport(1,new Uint8Array([3])),await this.device.sendReport(128,new Uint8Array([4])))}async rumble(e,t,a){let i,n=(e,t,a)=>Math.min(Math.max(e,t),a),s=new Uint8Array(9);s[0]=0;let r=n(e,40.875885,626.286133),c=n(t,81.75177,1252.572266);c=(Math.round(32*Math.log2(.1*c))-96)*4,r=Math.round(32*Math.log2(.1*r))-64;let l=n(a,0,1),o=.5*Math.round(i=0==l?0:l<.117?(32*Math.log2(1e3*l)-96)/(5-Math.pow(l,2))-1:l<.23?32*Math.log2(1e3*l)-96-92:(32*Math.log2(1e3*l)-96)*2-246),d=o%2;d>0&&--o,o>>=1,o+=64,d>0&&(o|=32768),s[1]=255&c,s[2]=i+(c>>>8&255),s[3]=r+(o>>>8&255),s[4]+=255&o;for(let e=0;e<4;e++)s[5+e]=s[1+e];await this.device.sendReport(16,new Uint8Array(s))}async setLEDState(e){await this.device.sendReport(1,new Uint8Array([0,0,0,0,0,0,0,0,0,48,e]))}async setLED(e){this.ledstate|=1<<e,await this.setLEDState(this.ledstate)}async resetLED(e){this.ledstate&=~(1<<e|1<<4+e),await this.setLEDState(this.ledstate)}async blinkLED(e){this.ledstate&=~(1<<e),this.ledstate|=1<<4+e,await this.setLEDState(this.ledstate)}_onInputReport(e){var u,h,p,w,y,m;let{data:v,reportId:x,device:b}=e;if(!v)return;let _=(v=((e,t)=>{let a=new e.constructor(e.length+t.length);return a.set(e,0),a.set(t,e.length),a})(new Uint8Array([x]),new Uint8Array(v.buffer))).map(e=>e.toString(16)),f={inputReportID:{_raw:v.slice(0,1),_hex:_.slice(0,1)}};switch(x){case 63:f={...f,buttonStatus:{_raw:v.slice(1,3),_hex:_.slice(1,3)},analogStick:{_raw:v.slice(3,4),_hex:_.slice(3,4)},filter:{_raw:v.slice(4),_hex:_.slice(4)}};break;case 33:case 48:let g,M,I,S;if(f={...f,timer:{_raw:v.slice(1,2),_hex:_.slice(1,2)},batteryLevel:{_raw:v.slice(2,3),_hex:_.slice(2,3),level:function(e){let t;switch(e[0]){case 8:t="full";break;case 4:t="medium";break;case 2:t="low";break;case 1:t="critical";break;case 0:t="empty";break;default:t="charging"}return t}(_.slice(2,3))},connectionInfo:{_raw:v.slice(2,3),_hex:_.slice(2,3)},buttonStatus:{_raw:(u=v).slice(3,6),_hex:_.slice(3,6),y:!!(1&u[3]),x:!!(2&u[3]),b:!!(4&u[3]),a:!!(8&u[3]),r:!!(64&u[3]),zr:!!(128&u[3]),down:!!(1&u[5]),up:!!(2&u[5]),right:!!(4&u[5]),left:!!(8&u[5]),l:!!(64&u[5]),zl:!!(128&u[5]),sr:!!(16&u[3])||!!(16&u[5]),sl:!!(32&u[3])||!!(32&u[5]),minus:!!(1&u[4]),plus:!!(2&u[4]),rightStick:!!(4&u[4]),leftStick:!!(8&u[4]),home:!!(16&u[4]),capture:!!(32&u[4]),chargingGrip:!!(128&u[4])},analogStickLeft:(g=(((g=(h=v)[6]|(15&h[7])<<8)/1995-1)*2).toFixed(1),M=(((M=-((h[7]>>4|h[8]<<4)*1))/2220+1)*2).toFixed(1),{_raw:h.slice(6,9),_hex:_.slice(6,9),horizontal:g,vertical:M}),analogStickRight:(I=(((I=(p=v)[9]|(15&p[10])<<8)/1995-1)*2).toFixed(1),S=(((S=-((p[10]>>4|p[11]<<4)*1))/2220+1)*2).toFixed(1),{_raw:p.slice(9,12),_hex:_.slice(9,12),horizontal:I,vertical:S}),vibrator:{_raw:v.slice(12,13),_hex:_.slice(12,13)}},33===x&&(f={...f,ack:{_raw:v.slice(13,14),_hex:_.slice(13,14)},subcommandID:{_raw:v.slice(14,15),_hex:_.slice(14,15)},subcommandReplyData:{_raw:v.slice(15),_hex:_.slice(15)},deviceInfo:function(e,t){let a=e.slice(15,26),i=a.slice(0,1)[0],n=a.slice(1,2)[0],r=a.slice(2,3),c=a.slice(4,10),l=[];c.forEach(e=>{l.push(e.toString(16))});let o=a.slice(11,12);return{_raw:a.slice(0,12),_hex:a.slice(0,12),firmwareVersion:{major:i,minor:n},type:s[r[0]],macAddress:l.join(":"),spiColorInUse:1===o[0]}}(v,0)}),48===x){let e=[{x:{_raw:(w=v).slice(13,15),_hex:_.slice(13,15),acc:c(w.slice(13,15))},y:{_raw:w.slice(15,17),_hex:_.slice(15,17),acc:c(w.slice(15,17))},z:{_raw:w.slice(17,19),_hex:_.slice(17,19),acc:c(w.slice(17,19))}},{x:{_raw:w.slice(25,27),_hex:_.slice(25,27),acc:c(w.slice(25,27))},y:{_raw:w.slice(27,29),_hex:_.slice(27,29),acc:c(w.slice(27,29))},z:{_raw:w.slice(29,31),_hex:_.slice(29,31),acc:c(w.slice(29,31))}},{x:{_raw:w.slice(37,39),_hex:_.slice(37,39),acc:c(w.slice(37,39))},y:{_raw:w.slice(39,41),_hex:_.slice(39,41),acc:c(w.slice(39,41))},z:{_raw:w.slice(41,43),_hex:_.slice(41,43),acc:c(w.slice(41,43))}}],s=[[{_raw:(y=v).slice(19,21),_hex:_.slice(19,21),dps:l(y.slice(19,21)),rps:o(y.slice(19,21))},{_raw:y.slice(21,23),_hex:_.slice(21,23),dps:l(y.slice(21,23)),rps:o(y.slice(21,23))},{_raw:y.slice(23,25),_hex:_.slice(23,25),dps:l(y.slice(23,25)),rps:o(y.slice(23,25))}],[{_raw:y.slice(31,33),_hex:_.slice(31,33),dps:l(y.slice(31,33)),rps:o(y.slice(31,33))},{_raw:y.slice(33,35),_hex:_.slice(33,35),dps:l(y.slice(33,35)),rps:o(y.slice(33,35))},{_raw:y.slice(35,37),_hex:_.slice(35,37),dps:l(y.slice(35,37)),rps:o(y.slice(35,37))}],[{_raw:y.slice(43,45),_hex:_.slice(43,45),dps:l(y.slice(43,45)),rps:o(y.slice(43,45))},{_raw:y.slice(45,47),_hex:_.slice(45,47),dps:l(y.slice(45,47)),rps:o(y.slice(45,47))},{_raw:y.slice(47,49),_hex:_.slice(47,49),dps:l(y.slice(47,49)),rps:o(y.slice(47,49))}]],u=d(s.map(e=>e.map(e=>e.rps))),h=d(s.map(e=>e.map(e=>e.dps))),p=function(e){let t=.005*e.length;return{x:parseFloat((n(e.map(e=>e[0]))*t).toFixed(6)),y:parseFloat((n(e.map(e=>e[1]))*t).toFixed(6)),z:parseFloat((n(e.map(e=>e[2]))*t).toFixed(6))}}(e.map(e=>[e.x.acc,e.y.acc,e.z.acc])),x=8198===b.productId?(t.update(u.x,u.y,u.z,p.x,p.y,p.z),t.getQuaternion()):(a.update(u.x,u.y,u.z,p.x,p.y,p.z),a.getQuaternion());f={...f,accelerometers:e,gyroscopes:s,actualAccelerometer:p,actualGyroscope:{dps:h,rps:u},actualOrientation:function(e,t,a,i){let n=Date.now(),s=e.timestamp?(n-e.timestamp)/1e3:0;e.timestamp=n;let c=Math.sqrt(a.x**2+a.y**2+a.z**2);return e.alpha=.9875*(e.alpha+t.z*s),0!==c&&(e.beta=.75*(e.beta+t.x*s)+.25*(a.x*r/c),e.gamma=.75*(e.gamma+t.y*s)+.25*(-(a.y*r)/c)),{alpha:8198===i?(-1*(180*e.alpha)/Math.PI*430%90).toFixed(6):(180*e.alpha/Math.PI*430%360).toFixed(6),beta:(-1*(180*e.beta)/Math.PI).toFixed(6),gamma:8198===i?(-1*(180*e.gamma)/Math.PI).toFixed(6):(180*e.gamma/Math.PI).toFixed(6)}}(this.lastValues,u,p,b.productId),actualOrientationQuaternion:function(e){let t=e.w*e.w,a=e.x*e.x,n=e.y*e.y,s=e.z*e.z;return{alpha:(i*Math.atan2(2*(e.x*e.y+e.z*e.w),a-n-s+t)).toFixed(6),beta:(-(i*Math.asin(2*(e.x*e.z-e.y*e.w)))).toFixed(6),gamma:(i*Math.atan2(2*(e.y*e.z+e.x*e.w),-a-n+s+t)).toFixed(6)}}(x),quaternion:x,ringCon:{_raw:(m=v).slice(38,2),_hex:_.slice(38,2),strain:new DataView(m.buffer,39,2).getInt16(0,!0)}}}}f.deviceInfo?.type&&this._receiveDeviceInfo(f.deviceInfo),f.batteryLevel?.level&&this._receiveBatteryLevel(f.batteryLevel),this._receiveInputEvent(f)}_receiveDeviceInfo(e){this.dispatchEvent(new CustomEvent("deviceinfo",{detail:e}))}_receiveBatteryLevel(e){this.dispatchEvent(new CustomEvent("batterylevel",{detail:e}))}}class p extends h{constructor(e){super(e)}_receiveInputEvent(e){delete e.buttonStatus.x,delete e.buttonStatus.y,delete e.buttonStatus.b,delete e.buttonStatus.a,delete e.buttonStatus.plus,delete e.buttonStatus.r,delete e.buttonStatus.zr,delete e.buttonStatus.home,delete e.buttonStatus.rightStick,this.dispatchEvent(new CustomEvent("hidinput",{detail:e}))}}class w extends h{constructor(e){super(e)}_receiveInputEvent(e){delete e.buttonStatus.up,delete e.buttonStatus.down,delete e.buttonStatus.left,delete e.buttonStatus.right,delete e.buttonStatus.minus,delete e.buttonStatus.l,delete e.buttonStatus.zl,delete e.buttonStatus.capture,delete e.buttonStatus.leftStick,this.dispatchEvent(new CustomEvent("hidinput",{detail:e}))}}class y extends h{constructor(e){super(e)}_receiveInputEvent(e){this.dispatchEvent(new CustomEvent("hidinput",{detail:e}))}}const m=new Map,v=[],x=e=>{let t=v.indexOf(e);return t>=0?t:(v.push(e),v.length-1)},b=async e=>{let t=x(e);console.log(`HID connected: ${t} ${e.productId.toString(16)} ${e.productName}`),m.set(t,await g(e))},_=async e=>{let t=x(e);console.log(`HID disconnected: ${t} ${e.productId.toString(16)} ${e.productName}`),m.delete(t)};navigator.hid.addEventListener("connect",async({device:e})=>{b(e)}),navigator.hid.addEventListener("disconnect",({device:e})=>{_(e)}),document.addEventListener("DOMContentLoaded",async()=>{(await navigator.hid.getDevices()).forEach(async e=>{await b(e)})});const f=async()=>{try{let[e]=await navigator.hid.requestDevice({filters:[{vendorId:1406}]});if(!e)return;await b(e)}catch(e){console.error(e.name,e.message)}},g=async e=>{let t=null;return 8198===e.productId?t=new p(e):8199===e.productId&&"Joy-Con (R)"===e.productName&&(t=new w(e)),t||(t=new y(e)),await t.open(),await t.enableUSBHIDJoystickReport(),await t.enableStandardFullMode(),await t.enableIMUMode(),t};document.querySelector("#connect-joy-cons").addEventListener("click",f);const M=(e,t)=>document.querySelector(e).classList.toggle("highlight",t),I=e=>{e&&document.querySelector(`audio[data-key="${e}"]`).play()},S=(e,t)=>{if(!t||!t.actualOrientation)return;let{buttonStatus:a}=t;e instanceof p&&(M("#up",a.up),M("#down",a.down),M("#left",a.left),M("#right",a.right),M("#capture",a.capture),M("#l",a.l||a.zl),M("#minus",a.minus),M("#joystick-left",a.leftStick),a.up&&I("crash"),a.down&&I("snare"),a.left&&I("hi-hat"),a.right&&I("hi-hat-open"),a.l&&I("clap"),a.zl&&I("bass")),e instanceof w&&(M("#a",a.a),M("#b",a.b),M("#x",a.x),M("#y",a.y),M("#home",a.home),M("#r",a.r||a.zr),M("#plus",a.plus),M("#joystick-right",a.rightStick),a.a&&I("tom-l"),a.b&&I("tom-f"),a.x&&I("ride"),a.y&&I("tom-s"),a.r&&I("tink"),a.zr&&I("bass"))};setInterval(async()=>{for(let e of m.values())e.eventListenerAttached||(e.eventListenerAttached=!0,await e.enableVibration(),e.addEventListener("hidinput",t=>{S(e,t.detail)}))},2e3);const E=document.getElementById("controls"),z=document.getElementById("btn-controls");window.onclick=e=>{e.target===E&&(E.style.display="none")},z.onclick=()=>{E.style.display&&"none"!==E.style.display?E.style.display="none":E.style.display="block"};